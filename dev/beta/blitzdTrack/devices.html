<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>blitzdTrack beta</title>
    <script src="https://blitzduk.github.io/dev/osint/unique.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
        :root {
            --light-text: #f0f0f0;
            --dark-bg: #0d0d0d;
            --dark-card-bg: #1a1a1a;
            --dark-border: #333333;
            --dark-table-header-bg: #262626;
            --dark-table-striped-bg: #1f1f1f;
            --refresh-indicator-color: #28a745;
            --error-color: #dc3545;
            --header-padding: 1rem 2rem;
        }

        /* General & Layout */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: var(--dark-bg);
            color: var(--light-text);
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            display: flex;
            flex-direction: column;
        }

        .container-fluid {
            flex-grow: 1;
            padding: 2rem;
            max-width: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }

        /* Header & Footer */
        .app-header {
            flex-shrink: 0;
            background-color: var(--dark-card-bg);
            border-bottom: 1px solid var(--dark-border);
            padding: var(--header-padding);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-header h1 {
            color: var(--light-text);
            font-weight: 600;
            margin-bottom: 0;
            font-size: 1.8rem;
        }

        .app-footer {
            flex-shrink: 0;
            background-color: var(--dark-card-bg);
            border-top: 1px solid var(--dark-border);
            padding: 1rem;
            text-align: center;
            color: var(--light-text);
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .app-footer a {
            color: var(--light-text);
            text-decoration: underline;
        }

        .disclaimer {
            margin-top: 0.75rem;
            line-height: 1.4;
        }

        /* Cards & Components */
        .app-card {
            background-color: var(--dark-card-bg);
            border: 1px solid var(--dark-border);
            border-radius: 0.75rem;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
            margin-top: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .app-card-header {
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--dark-border);
        }

        .text-muted {
            color: var(--light-text) !important;
            opacity: 0.75;
            font-size: 0.85rem;
        }

        .refresh-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: var(--refresh-indicator-color);
            border-radius: 50%;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }

        .loading-message, .error-message {
            text-align: center;
            padding: 1rem;
            color: var(--light-text);
            opacity: 0.75;
        }

        .error-message {
            color: var(--error-color);
            font-weight: bold;
            margin-top: 1rem;
            opacity: 1;
        }

        /* Custom Table Styling */
        .table-container {
            flex-grow: 1;
            overflow-x: auto;
            background-color: var(--dark-card-bg);
            border-radius: 0.75rem;
        }

        .styled-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8em;
            background-color: var(--dark-card-bg);
            border: none;
        }

        .styled-table th, .styled-table td {
            padding: 8px 10px;
            text-align: center;
            border-right: 1px solid var(--dark-border);
            border-bottom: 1px solid var(--dark-border);
            word-wrap: break-word;
            white-space: nowrap;
        }

        .styled-table thead tr {
            background-color: var(--dark-table-header-bg);
            color: var(--light-text);
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .styled-table tbody tr {
            border-bottom: 1px solid var(--dark-border);
        }

        .styled-table tbody tr:nth-of-type(even) {
            background-color: var(--dark-table-striped-bg);
        }

        .styled-table tbody tr:last-of-type {
            border-bottom: none;
        }
        /* Pagination Styling */
        .pagination-container {
            flex-shrink: 0;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            background-color: var(--dark-card-bg);
            padding-top: 1rem;
        }
        .pagination-container button {
            background-color: var(--dark-table-header-bg);
            color: var(--light-text);
            border: none;
            padding: 0.5rem 0.75rem;
            margin: 0 0.25rem;
            cursor: pointer;
            border-radius: 0.25rem;
        }
        .pagination-container button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-container span {
            margin: 0 0.5rem;
            color: var(--light-text);
        }

        /* Map */
        .map-card {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            margin-top: 20px;
        }

        #map-container {
            width: 100%;
            flex-grow: 1;
            border-radius: 0.75rem;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
            background-color: var(--dark-card-bg);
        }

        .leaflet-layer,
        .leaflet-control-zoom-in,
        .leaflet-control-zoom-out,
        .leaflet-control-attribution {
            filter: invert(100%) hue-rotate(180deg) brightness(100%) contrast(100%);
        }

        /* Popup Content Styling */
        .leaflet-popup-content-wrapper {
            text-align: center;
        }
        .leaflet-popup-content {
            text-align: center;
        }

        /* Pulsing marker */
        .pulse-marker {
            width: 20px;
            height: 20px;
            background: rgba(0, 255, 255, 0.3);
            border: 2px solid cyan;
            border-radius: 50%;
            position: relative;
        }

        .pulse-marker::after {
            content: "";
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(0, 255, 255, 0.5);
            position: absolute;
            top: 0;
            left: 0;
            animation: pulse 1.5s infinite;
            z-index: -1;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }
            70% {
                transform: scale(3.5);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 0;
            }
        }

        /* Mobile adjustments */
        @media (max-width: 768px) {
            .app-header h1 {
                font-size: 1.4rem;
            }
            .app-card {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <header class="app-header">
        <h1>blitzdTrack beta</h1>
        <p class="text-muted mb-0" aria-live="polite">Last update: <span id="last-updated">--</span> <span class="refresh-indicator"></span></p>
    </header>

    <main class="container-fluid main-content">
        <section class="app-card">
            <div class="app-card-header">
                <h3 class="mb-0">Devices</h3>
            </div>

            <div id="status-message" aria-live="polite">
                <div id="loading-message" class="loading-message">
                    <i class="fas fa-spinner fa-spin me-2"></i> Loading log data...
                </div>
                <div id="error-message" class="error-message" style="display:none;"></div>
            </div>

            <div class="table-container">
                <table class="styled-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Device</th>
                            <th>Coordinates</th>
                            <th>Altitude</th>
                            <th>Speed</th>
                            <th>Accuracy</th>
                            <th>Pressure</th>
                            <th>Location</th>
                            <th>Status</th>
                            <th>Duration (hh:mm)</th>
                            <th>Updated</th>
                        </tr>
                    </thead>
                    <tbody id="log-table-body">
                        </tbody>
                </table>
            </div>
            <div class="pagination-container">
                <button id="first-btn" disabled>First</button>
                <button id="prev-btn" disabled>Prev</button>
                <span>Page <span id="current-page">1</span> of <span id="total-pages">1</span></span>
                <button id="next-btn" disabled>Next</button>
                <button id="last-btn" disabled>Last</button>
            </div>
        </section>

        <section class="app-card map-card">
            <div class="app-card-header">
            </div>
            <div id="map-container">
                <div id="map"></div>
            </div>
        </section>
    </main>

    <footer class="app-footer">
        <p class="mt-2 disclaimer">
            The data provided on this platform is for informational purposes only. We do not guarantee its completeness, accuracy, or timeliness, as this can be affected by external sources and other factors beyond our control.<br>This information is not intended for safety-critical applications and must not be used for any purpose involving personal or public safety.
        </p>
        <p class="m-0">
            |Telemetry powered by blitzdTrack beta | Geography and Geolocation information provided by Leaflet, OpenStreetMap, Overpass Turbo and Nominatim | GPS data powered by Apple Core Location |
        </p>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const lastUpdatedSpan = document.getElementById('last-updated');
            const loadingMessage = document.getElementById('loading-message');
            const errorMessage = document.getElementById('error-message');
            const logTableBody = document.getElementById('log-table-body');
            const currentPageSpan = document.getElementById('current-page');
            const totalPagesSpan = document.getElementById('total-pages');
            const firstBtn = document.getElementById('first-btn');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const lastBtn = document.getElementById('last-btn');

            const CSV_FILE_PATH = "https://dev.gbya.co.uk:1880/data/ios/log";
            const REFRESH_INTERVAL_MS = 30000;
            const ROWS_PER_PAGE = 2;

            let map, marker;
            const maxZoom = 19;
            let intervalId = null;
            let allData = [];
            let currentPage = 1;
            let isMapInitialized = false;

            function initMap(lat, lon) {
                if (isMapInitialized) return;
                map = L.map('map').setView([lat, lon], maxZoom);
                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: maxZoom,
                    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                isMapInitialized = true;
            }

            function updateMap(lat, lon, deviceID) {
                if (!isMapInitialized) {
                    initMap(lat, lon);
                }

                const newLatLng = L.latLng(lat, lon);
                const customIcon = L.divIcon({
                    className: 'pulse-marker',
                    iconSize: [20, 20]
                });

                if (!marker) {
                    // If marker doesn't exist, create it.
                    marker = L.marker(newLatLng, { icon: customIcon }).addTo(map);
                    marker.bindPopup(`<b>Device:</b><br>${deviceID}`);
                    marker.on('click', function () {
                        this.openPopup();
                    });
                } else {
                    // If coordinates have changed, update the marker's position.
                    const currentLatLng = marker.getLatLng();
                    if (!currentLatLng.equals(newLatLng)) {
                        marker.setLatLng(newLatLng);
                    }
                    // Always update the popup content in case other data has changed.
                    marker.setPopupContent(`<b>Device:</b><br>${deviceID}`);
                }
                map.setView(newLatLng, map.getMaxZoom());
            }

            function renderTable() {
                const start = (currentPage - 1) * ROWS_PER_PAGE;
                const end = start + ROWS_PER_PAGE;
                const paginatedData = allData.slice(start, end);

                // Remove rows that are no longer in the current page
                const existingRows = Array.from(logTableBody.querySelectorAll('tr'));
                existingRows.forEach(row => {
                    const rowId = row.dataset.id;
                    const isStillInPage = paginatedData.some(d => d.Timestamp === rowId);
                    if (!isStillInPage) {
                        row.remove();
                    }
                });

                // Update or create rows
                paginatedData.forEach(row => {
                    let existingRow = logTableBody.querySelector(`tr[data-id="${row.Timestamp}"]`);

                    const newRowHtml = `
                        <td>${row.Timestamp || ''}</td>
                        <td>${row.deviceID || ''}</td>
                        <td>${row.coordinates || ''}</td>
                        <td>${row.locationAltitude || ''}</td>
                        <td>${row.locationSpeed || ''}</td>
                        <td>${row.locationHorizontalAccuracy || ''}</td>
                        <td>${row.altimeterPressure || ''}</td>
                        <td>${row.display_name || ''}</td>
                        <td>${row.Status || ''}</td>
                        <td>${row.Duration || ''}</td>
                        <td>${row.UpdatedTimestamp || ''}</td>
                    `;

                    if (existingRow) {
                        // Update content of existing row
                        existingRow.innerHTML = newRowHtml;
                    } else {
                        // Create and append new row
                        const tr = document.createElement('tr');
                        tr.dataset.id = row.Timestamp;
                        tr.innerHTML = newRowHtml;
                        logTableBody.appendChild(tr);
                    }
                });

                updatePaginationControls();
            }

            function updatePaginationControls() {
                const totalPages = Math.ceil(allData.length / ROWS_PER_PAGE);
                currentPageSpan.textContent = currentPage;
                totalPagesSpan.textContent = totalPages > 0 ? totalPages : 1;

                firstBtn.disabled = currentPage === 1;
                prevBtn.disabled = currentPage === 1;
                nextBtn.disabled = currentPage >= totalPages;
                lastBtn.disabled = currentPage >= totalPages;
            }

            function fetchLogData() {
                loadingMessage.style.display = 'block';
                errorMessage.style.display = 'none';

                fetch(CSV_FILE_PATH, { cache: "no-store" })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(csvText => {
                        loadingMessage.style.display = 'none';
                        const { data, errors } = Papa.parse(csvText, {
                            header: true,
                            dynamicTyping: true,
                            skipEmptyLines: true
                        });

                        if (errors.length > 0) {
                            throw new Error("CSV parsing errors detected.");
                        }

                        if (data.length === 0) {
                            allData = [];
                            renderTable();
                            lastUpdatedSpan.textContent = new Date().toLocaleTimeString();
                            return;
                        }

                        allData = data.map(row => {
                            if (row.locationLatitude && row.locationLongitude) {
                                row.coordinates = `${parseFloat(row.locationLatitude).toFixed(6)}, ${parseFloat(row.locationLongitude).toFixed(6)}`;
                            } else {
                                row.coordinates = '';
                            }
                            if (row.locationAltitude) {
                                row.locationAltitude = parseFloat(row.locationAltitude).toFixed(2);
                            }
                            if (row.locationHorizontalAccuracy) {
                                row.locationHorizontalAccuracy = parseFloat(row.locationHorizontalAccuracy).toFixed(2);
                            }
                            if (row.locationSpeed !== null && row.locationSpeed !== undefined) {
                                row.locationSpeed = parseFloat(row.locationSpeed).toFixed(2);
                            } else {
                                row.locationSpeed = '0.00';
                            }
                            if (row.altimeterPressure !== null && row.altimeterPressure !== undefined) {
                                row.altimeterPressure = parseFloat(row.altimeterPressure).toFixed(2);
                            } else {
                                row.altimeterPressure = '';
                            }
                            row.Status = row.EventType || 'N/A';
                            row.Duration = row['Duration(s)'] || '';
                            return row;
                        });

                        allData.sort((a, b) => new Date(a.Timestamp) - new Date(b.Timestamp));

                        renderTable();

                        const lastRow = allData[allData.length - 1];
                        const lat = parseFloat(lastRow.locationLatitude);
                        const lon = parseFloat(lastRow.locationLongitude);
                        const deviceID = lastRow.deviceID;

                        if (!isNaN(lat) && !isNaN(lon)) {
                            updateMap(lat, lon, deviceID);
                        } else {
                            console.warn('Invalid coordinates in the last log entry.');
                        }

                        lastUpdatedSpan.textContent = new Date().toLocaleTimeString();
                    })
                    .catch(e => {
                        loadingMessage.style.display = 'none';
                        errorMessage.style.display = 'block';
                        errorMessage.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i> Error fetching or parsing log file: ${e.message}.`;
                        console.error('Fetch error:', e);
                    });
            }

            firstBtn.addEventListener('click', () => {
                currentPage = 1;
                renderTable();
            });

            prevBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                }
            });

            nextBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(allData.length / ROWS_PER_PAGE);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable();
                }
            });

            lastBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(allData.length / ROWS_PER_PAGE);
                currentPage = totalPages;
                renderTable();
            });

            fetchLogData();
            intervalId = setInterval(() => {
                if (!document.hidden) {
                    fetchLogData();
                }
            }, REFRESH_INTERVAL_MS);

            window.addEventListener('beforeunload', () => {
                clearInterval(intervalId);
            });
        });
    </script>
</body>
</html>
